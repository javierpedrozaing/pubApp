/////////////////////////////Vista Como llegar  ////////////////////////////////
comoLlegar = Backbone.View.extend({
    
    initialize: function(){         
            this.$el;
    },  
    trazar:function(){
        self= this;
        var template = _.template($('#comoLlegarTemplate').html());
        self.$el.append(template);
        $("#info2ver").remove();
        $("#mapaver").remove();
        $(".iconosver").remove();
        $(".titulosver").remove();
        $("#info1ver").remove();
        $("#info1ver").remove();
        $("#descripver").remove();
        $(".contentr1").remove();
        $("#streetVista").remove();
        $(".container").remove();
        $(".flexslider").remove();
        $("#titulover").remove();
        $('#mapavistacerca').show();        
        $('#mapavista').hide();
        $('#contenedor1').hide();
        $('#itemscenter').hide();
        $('.contentr1').hide();
        $('#contenedor2').show().css('margin-bottom','65px');
        $('#contentContador').hide();
        $('#home').css('background', '#fff');
        $('.ui-content').css('margin-top', '0');
        $('#w').hide();
        $('#regresar1').show();
        $('#noresultados').css('height','0%');
        $('#espacioresultados').css('height','49px')
        var map;
        var mapOptions = {
                zoom: 15
        };
        map = new google.maps.Map(document.getElementById('mapavistacerca'),
        mapOptions);

        // Try HTML5 geolocation
        if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);
                var infowindow = new google.maps.Marker({
                map: map,
                position: pos,
                title: 'tu posición'
                });
                map.setCenter(pos);
                 }, function() {

                        var options = new google.maps.Marker({
                        zoom: 10,
                        map: map,
                        position: new google.maps.LatLng(60, 105),
                        title:'Error: The Geolocation service failed'
                        });
                        map.setCenter(options.position);
                });
                }else {
                        // Browser doesn't support Geolocation
                         this.handleNoGeolocation(false);
                 }
                 return this;
        },   
});

///////////////////////////// Vista cerca de mi ////////////////////////////////
cercaDeMi = Backbone.View.extend({
	
	initialize: function(){			
			this.$el;
	},	
	cerca:function(){
        self= this;
        var template = _.template($('#cercaDeMiTemplate').html());
        self.$el.append(template);
        $("#info2ver").remove();
        $("#mapaver").remove();
        $(".iconosver").remove();
        $(".titulosver").remove();
        $("#info1ver").remove();
        $("#info1ver").remove();
        $("#descripver").remove();
        $(".contentr1").remove();
        $("#streetVista").remove();
        $(".container").remove();
        $(".flexslider").remove();
        $("#titulover").remove();
        $('#mapavistacerca').show();        
        $('#mapavista').hide();
        $('#contenedor1').hide();
        $('#itemscenter').hide();
        $('.contentr1').hide();
        $('#contenedor2').show().css('margin-bottom','65px');
        $('#contentContador').hide();
        $('#home').css('background', '#fff');
        $('.ui-content').css('margin-top', '0');
        $('#w').hide();
        $('#regresar1').show();
        $('#noresultados').css('height','0%');
        $('#espacioresultados').css('height','49px')

        var map;
        var mapOptions = {
                zoom: 15
                
        };
        map = new google.maps.Map(document.getElementById('mapavistacerca'),
        mapOptions);

        // Try HTML5 geolocation
        if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);

                var infowindow = new google.maps.Marker({
                map: map,
                position: pos,
                title: 'tu posición'
                });
                map.setCenter(pos);
                 }, function() {

                        var options = new google.maps.Marker({
                        zoom: 10,
                        map: map,
                        position: new google.maps.LatLng(60, 105),
                        title:'Error: The Geolocation service failed'
                        });
                        map.setCenter(options.position);
                });
                }else {
                        // Browser doesn't support Geolocation
                         this.handleNoGeolocation(false);
                 }
                 return this;
        },   
});

/////////////////////////////Vista Resultados  ////////////////////////////////
ResultadosView = Backbone.View.extend({         
    events: {
        "touchstart #regresar1" : "search",
        "touchstart #option2" : "mostrarMapa",
        "click #option1" : "render",
        "click #regresar1" : "search",
        "click #option2" : "mostrarMapa"
    },
    initialize: function(){         
            this.$el;
    },  
    search : function(){
        var queBuscas= this.$el.find('#queBuscas').val();
        window.dondeBuscas= this.$el.find('#dondeBuscas').val();
        var ubicacion= this.$el.find('#localizacion').text();
        var palabras= ubicacion.split(",");
        if (dondeBuscas=="" || dondeBuscas==" ") {
            if (palabras[0]=="Buscando"){
                alert("no se pudo tomar la ubicacion se hara la consulta solo por el primer parametro de busqueda");
                alert(queBuscas+" esto es lugar "+dondeBuscas);
                 self= this;
                this.request(queBuscas ,dondeBuscas);    
            }else{
                alert("esta es tu ubicacion y se hara la busqueda por tal parametro"+palabras[0]);
                 self= this;
                this.request(queBuscas ,palabras[0]);
            }
            
        }else{
            alert(queBuscas+" "+dondeBuscas);
            self= this;
            this.request(queBuscas ,dondeBuscas);
        }
        },
    searchPopup : function(){
        $(".contentr1").remove();
        $("#busquedaAux").css('margin-top','-150%');
        $("#hamburger-overlayy").css('display','none')
        var queBuscas= this.$el.find('#queBuscass').val();
        var dondeBuscas= this.$el.find('#dondeBuscass').val();
        self= this;
        this.request(queBuscas ,dondeBuscas);
        },

    request : function(queBuscas , dondeBuscas){
        
        // Loading 
        $('#cargando').waitMe({
        //none, rotateplane, stretch, orbit, roundBounce, win8, 
        //win8_linear, ios, facebook, rotation, timer, pulse, 
        //progressBar, bouncePulse or img
        effect: 'timer',
        //place text under the effect (string).
        text: '',
        //background for container (string).
        bg: 'rgba(255,255,255)',
        //color for background animation and text (string).
        color: '#000',
        //change width for elem animation (string).
        sizeW: '',
        //change height for elem animation (string).
        sizeH: ''
        });
        //busqueda
        window.myLatlng;
        window.mapOptions;
        window.map;
        window.marker;
        window.vecId=0;
        window.totalResultados = 1;
        window.text;
        window.auxaumenta = 0;
        $("#dividendo").html(totalResultados);
        window.infor= $.ajax({
        url: "http://www.publitell.com/busquedas.json?utf8=%E2%9C%93&busqueda_principal="+queBuscas+"&busqueda_lugar="+dondeBuscas+"&x=0&y=0",
        type: "get",
        crossDomain: true,
        dataType: 'jsonp',
        cache:true,
        xhrFields: {
        withCredentials: true   
        },

        success: function(data,status, error){
                window.cont = vecId=vecId;
                window.items = data;   
         /*      window.cont = vecId=vecId+1;
                window.nombre = "Nombre Comercial";
                window.pais= items[0][1];
                window.departamento = items[0][2];
                window.municipio = items[0][3];
                window.barrio = items[0][4];
                window.direccion = items[0][5];
                window.telefono= items[0][6];
                window.celular1= items[0][7];
                window.email= items[0][10];
                window.web= items[0][11];
                window.items = data;        
       if (items[1] == null){

                console.log("empresa");
                window.cont = vecId=vecId+1;
                window.nombre = "Nombre Comercial";
                window.pais= items[0][1];
                window.departamento = items[0][2];
                window.municipio = items[0][3];
                window.barrio = items[0][4];
                window.direccion = items[0][5];
                window.telefono= items[0][6];
                window.celular1= items[0][7];
                window.email= items[0][10];
                window.web= items[0][11];

        }else{ 
            console.log("seccion o palabra");
            window.cont = vecId=vecId+1;
            window.nombre = items.NombreComercial;
            
        }*/    
        window.videosData = items.map(function(items){
        window.id;

        return{
                    cont: vecId=vecId+1,
                    title: items.NombreComercial,
                    pais: "Colombia",
                    departamento : "Meta",
                    municipio : "villavicencio",
                    barrio : "Sin Barrio",
                    direccion : "Cra 16 # 13 -20",
                    telefono: "7405060 - 7405060",
                    celular1: "3015426587",
                    email: "servicioalcliente@hotelcampanario.com",
                    web: "www.hotelcampanario.com",     
            }                
        });
        videosData.forEach(function(videoData){
        $("#dividendo").html(totalResultados);
        window.template = _.template($('#resultadosTemplate').html());
        window.videoHtml= template(videoData);
      
        totalResultados = totalResultados +1;
        self.$el.append(videoHtml);
        }); 
        window.numero=totalResultados;
        if (totalResultados>=5) {
            $('#contentContador').show();
            $('#cargando').waitMe('hide');
        }else{
              $('#contentContador').hide();
              $('#cargando').waitMe('hide');
        }
        if (totalResultados==1) {
            $('#noresultados').css('height','40%');
            $('#cargando').waitMe('hide');

        };
        },
        });

        $("#mapaver").remove();
        $(".iconosver").remove();
        $(".titulosver").remove();
        $("#info1ver").remove();
        $("#info2ver").remove();
        $("#descripver").remove();
        $(".contentr1").remove();
        $("#streetVista").remove();
        $(".container").remove();
        $(".flexslider").remove();
        $("#titulover").remove();
        $("#mapavistacerca").remove();
        $('#contenedor1').hide();
        $('#itemscenter').show();
        $('#contenedor2').show().css('margin-bottom','65px');
        $('#contentContador').show();
        $('#home').css('background','#fff');
        $('.ui-content').css('margin-top','0');
        $('#w').hide();
        $('#regresar1').show();
        $('#regresar1').css('float', 'left');
        $('#mapavista').css('display','none');
        $('#mapavistacerca').css('display','none');
        $('#streetVista').css('display','none');
        $('#noresultados').css('height','0%');



    },
    mostrarMapa:function(){

        $('#contenedor2').show().css('margin-bottom','65px');
        $('#contenedor1').hide();
        $('#itemscenter').show();
        $('#mapavista').css('display','block');      
        $('.contentr1').hide();
        $('#contentContador').hide();
        $('#home').css('background', '#fff');
        $('.ui-content').css('margin-top', '0');
        $('#w').hide();
        $('#regresar1').show();
        $('#mapavistacerca').hide();
        $('#noresultados').css('height','0%');
        $('#streetVista').css('display','none');

        myLatlng = new google.maps.LatLng(4.135441438193667,-433.6320342257324);
        mapOptions = {
            zoom: 15,
            center: myLatlng
        }
        mapMarker = new google.maps.Map(document.getElementById('mapavista'), mapOptions);
     
        marker = new google.maps.Marker({
        position: myLatlng,
        map: mapMarker,
        title: 'Hello World!'
        });

        var infowindow = new google.maps.InfoWindow({
        content: "hola estoy en villavicencio"
        })
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(marker.get('map'), marker);
        });
    },
    render: function(){
    //  this.$el.html(this.template(this.model.attributes));
     //   return this;
        if (totalResultados>=5) {
            $('#contentContador').show();
        }else{
              $('#contentContador').hide();
        }
        $('.contentr1').show();
        $('#contenedor1').hide();
        $('#itemscenter').show();
        $('#contenedor2').show().css('margin-bottom','65px');
        $('#contentContador').show();
        $('#home').css('background','#fff');
        $('.ui-content').css('margin-top','0');
        $('#w').hide();
        $('#regresar1').show();
        $('#regresar1').css('float', 'left');
        $('#mapavista').css('display','none');
        $('#noresultados').css('height','0%');
        $('#mapavistacerca').hide();
    }
    
});

///////////////////////////////////// Vista Ver Mas ////////////////////////////////////////////
VerMas = Backbone.View.extend({

    initialize: function(){         
            this.$el;
    },  
    mostrarEmpresa:function(nombreEmpresa){
        self= this;
        var template = _.template($('#VerMasTemplate').html());
        self.$el.append(template);
        window.nombre = nombreEmpresa;
        /////////////// Consulta a json con info de la empresa ///////////////
        window.infoEmpresa = $.ajax({
            url:"http://publitell.com/busquedas.json?utf8=%E2%9C%93&busqueda_principal="+nombre+"&",
            type: "get",
            crossDomain: true,
            dataType: 'jsonp',
            cache:true,
            xhrFields: {
            withCredentials: true   
            },
            success: function(data,status, error){
                window.articulo = data;
                window.vecInfoEmpresa = articulo.map(function(items){
                      window.barrio = (items[0]+" - "+items[1]+" - "+items[2]+" - "+items[3]);
                      $("#vermas11").text(items[4]);
                      $("#vermas12").text(barrio);
                      window.telefonos = items[5].concat(" ",items[6]," ",items[7]," ",items[8]," ",items[9]);
                      $("#vermas13").text(telefonos);
                      var email = items[10];
                      $("#vermas14").text(email);
                      var webpage = items[11];
                      $("#vermas15").text(webpage);
                });
            },

        });
        /////////////// Consulta a json con info productos de la empresa  ///////////////

        window.infor2= $.ajax({
        url: "http://publitell.com/json/servicios.json/?utf8=%E2%9C%93&NombreComercial=Publitell+ltda&",
        type: "get",
        crossDomain: true,
        dataType: 'jsonp',        

        success: function(data,status, error){
            window.infoIndice = data;   
           
        window.infoservs = infoIndice.map(function(items){
        return{
                    
                    titulo: items.titulo,
                   
            }                
        });
        
        for (var i =0; i <= infoservs.length; i++) {
             console.log(infoservs[i]['titulo']);
        };
        
        },
        });
    
        $("#nombreEmpresa").text(nombre);
        $('#itemscenter').hide();
        $('#contenedor1').hide();
        $('#contenedor2').hide();
        $('.contentr1').hide();
        $('#contenedor2').show().css('margin-bottom','55px');
        $('#w').hide();
        $('.ui-content').css('margin-top', '0');
        $('#contentContador').hide();
        $('#noresultados').css('height','0%');
        $('.slides').css('margin','0');
        $('.slides').css('padding','0');
        $('.slides').css('list-style','none');
        //script galeria flexsilder para ver mas      
        $('.flexslider').flexslider({
            animation: "slide"
        });
        //script galeria flexsilder para ver mas    
        $( '.panel-content' ).hide();
        // Preparing the DOM
        // -- Update the markup of accordion container 
        $( '.accordion' ).attr({
            role: 'tablist',
            multiselectable: 'true'
        });

        // -- Adding ID, aria-labelled-by, role and aria-labelledby attributes to panel content
        $( '.panel-content' ).attr( 'id', function( IDcount ) { 
            return 'panel-' + IDcount; 
        });
        $( '.panel-content' ).attr( 'aria-labelledby', function( IDcount ) { 
        return 'control-panel-' + IDcount; 
        });
        $( '.panel-content' ).attr( 'aria-hidden' , 'true' );
        // ---- Only for accordion, add role tabpanel
        $( '.accordion .panel-content' ).attr( 'role' , 'tabpanel' );
  
        // -- Wrapping panel title content with a <a href="">
        $( '.panel-title' ).each(function(i){
    
         // ---- Need to identify the target, easy it's the immediate brother
         $target = $(this).next( '.panel-content' )[0].id;
    
        // ---- Creating the link with aria and link it to the panel content
        $link = $( '<a>', {
            'href': '#' + $target,
            'aria-expanded': 'false',
            'aria-controls': $target,
            'id' : 'control-' + $target
        });
    
        // ---- Output the link
        $(this).wrapInner($link);  
    
        });

        // Optional : include an icon. Better in JS because without JS it have non-sense.
        $( '.panel-title a' ).append('<span class="icon"><img src="img/desplegable.png"/></span>');

        // Now we can play with it
        $( '.panel-title a' ).click(function() {
    
            if ($(this).attr( 'aria-expanded' ) == 'false'){ //If aria expanded is false then it's not opened and we want it opened !
      
            // -- Only for accordion effect (2 options) : comment or uncomment the one you want
      
            // ---- Option 1 : close only opened panel in the same accordion
             //      search through the current Accordion container for opened panel and close it, remove class and change aria expanded value
            $(this).parents( '.accordion' ).find( '[aria-expanded=true]' ).attr( 'aria-expanded' , false ).removeClass( 'active' ).parent().next( '.panel-content' ).slideUp(200).attr( 'aria-hidden' , 'true');

            // Option 2 : close all opened panels in all accordion container
            //$('.accordion .panel-title > a').attr('aria-expanded', false).removeClass('active').parent().next('.panel-content').slideUp(200);
      
            // Finally we open the panel, set class active for styling purpos on a and aria-expanded to "true"
            $(this).attr( 'aria-expanded' , true ).addClass( 'active' ).parent().next( '.panel-content' ).slideDown(200).attr( 'aria-hidden' , 'false');

            } else { // The current panel is opened and we want to close it

        $(this).attr( 'aria-expanded' , false ).removeClass( 'active' ).parent().next( '.panel-content' ).slideUp(200).attr( 'aria-hidden' , 'true');;

        }
        // No Boing Boing
        return false;
        });

      // Script mapa 

      myLatlng = new google.maps.LatLng(4.135441438193667,-433.6320342257324);
        mapOptions = {
            zoom: 15,
            center: myLatlng
        }
        mapMarker = new google.maps.Map(document.getElementById('mapaver'), mapOptions);
     
        marker = new google.maps.Marker({
        position: myLatlng,
        map: mapMarker,
        title: 'Hello World!'
        });

        var infowindow = new google.maps.InfoWindow({
        content: "hola estoy en villavicencio"
        })
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(marker.get('map'), marker);
        });
        // script street view
        var bryantPark = new google.maps.LatLng(4.135441438193667,-433.6320342257324);
        var panoramaOptions = {
            position: bryantPark,
            pov: {
                heading: 165,
                pitch: 0
            },
            zoom: 1
            };
        var myPano = new google.maps.StreetViewPanorama(
            document.getElementById('streetVista'),
            panoramaOptions);
        myPano.setVisible(true);
    }
}); 
///////////////////////////// Definicion de Rutas  ////////////////////////////////
var Router = Backbone.Router.extend({

            cerca: null,
            resultados: null,
            vermas:null,
            comoLlegar:null,
            //definimos las rutas
            initialize: function () {
            this.cerca = new cercaDeMi({ el: $(".ui-content") });
            this.resultados = new ResultadosView({ el: $(".ui-content")});
            this.vermas = new VerMas({ el: $(".ui-content")});
            this.comoLlegar = new comoLlegar({ el: $(".ui-content")});
            },
            routes:{
                "": "home", // la url por defecto va a llamar a la función home
                "cercademi": "cercademi", //la url #cercademi va a llamar a cercademi
                "resultados": "busqueda", //la url #resultados va a llamar a busqueda
                "resultadosAuxiliar":"busquedaAuxiliar",
                "home" : "homeDos",
                "vermas/:nombreEmpresa":"vermas",
                "comoLlegar":"comoLlegar"
            },
            

            home: function(){
                window.pagina=1;
                $('.contentr1').hide();
                $('#contenedor1').show();
                $('#contenedor2').show();
                $('#w').show();
                $('#contentContador').hide();
                $('#regresar1').hide();
                $('#itemscenter').hide();
                $('.results').hide();
                $('#home').css('background', '');
                $('#mapavista').css('display','none');
                $('#mapavistacerca').css('display','none');
                $('#streetVista').css('display','none');
                $('.flexslider').css('display','none');
                $('#espacioresultados').css('height','49px');
                $('#noresultados').css('height','0%');

            },

            homeDos: function(){
                pagina=1;
                $("#info2ver").remove();
                $("#info1ver").remove();
                $(".titulosver").remove();
                $("#descripver").remove();
                $(".contentr1").remove();
                $("#streetVista").remove();
                $(".container").remove();
                $(".flexslider").remove();
                $("#titulover").remove();
                $(".iconosver").remove();
                $("#mapaver").remove();
                $("#mapavistacerca").remove();
                $('.contentr1').hide();
                $('#contenedor1').show();
                $('#contenedor2').show();
                $('#w').show();
                $('#contentContador').hide();
                $('#regresar1').hide();
                $('#itemscenter').hide();
                $('.results').hide();
                $('#home').css('background', '');
                $('#mapavista').hide();
                $('#mapavistacerca').hide();
                $('#noresultados').css('height','0%');
                $('.slides').css('height','100%');
                $('.slides').css('overflow','hidden');
                $('.slides').css('-webkit-backface-visibility','hidden');
                $('.slides').css('-webkit-transform-style','preserve-3d');
                $('.slides').css('-webkit-transition','all 500ms cubic-bezier(0.165, 0.840, 0.440, 1.000)');
                $('.slides').css('-moz-transition','all 500ms cubic-bezier(0.165, 0.840, 0.440, 1.000)');
                $('.slides').css('-ms-transition','all 500ms cubic-bezier(0.165, 0.840, 0.440, 1.000)');
                $('.slides').css('-o-transition','all 500ms cubic-bezier(0.165, 0.840, 0.440, 1.000)');
                $('.slides').css('transition','all 500ms cubic-bezier(0.165, 0.840, 0.440, 1.000)');
                $('#w').css('margin-top','90px');
                console.log("a ocultar menu");
                current = nav.css('margin-left'),
                val = '100%',
                layer = 'none',
                opacity = 0.0,
                ham = 0;
                botonMostrar.addClass("is-active");
                botonOcultar.removeClass("is-active");
                nav.animate({'margin-left': [val]}, {
                duration: 80
                });
                overlay.animate({'opacity': [opacity]}, {
                duration: 80,
                complete: function() {
                overlay.css('display', layer);
                }
                });
            },
            comoLlegar:function(){
                pagina=0;
                if (this.cerca == null) {
                this.comoLlegar = new comoLlegar();
                }
                 this.comoLlegar.trazar();
            },
            cercademi: function(){
                pagina=0;
                if (this.cerca == null) {
                this.cerca = new cercaDeMi();
                }
                 this.cerca.cerca();    
            },
            busqueda: function(){
                pagina=0;
                if (this.resultados == null) {
                this.resultados = new ResultadosView();
                }
                 this.resultados.search();    
            },
            busquedaAuxiliar: function(){
                pagina=0;
                if (this.resultados == null) {
                this.resultados = new ResultadosView();
                }
                 this.resultados.searchPopup();    
            },
            vermas: function(nombreEmpresa){
                window.nombreEmpresa=nombreEmpresa;
                pagina=0;
                if (this.vermas == null) {
                this.vermas = new VerMas();
                }
                 this.vermas.mostrarEmpresa(nombreEmpresa);    
            },
              
    }); 

    enrutador = new Router();
    Backbone.history.start ();


    function showConfirm() {
           navigator.notification.confirm(
              '¿Seguro que quieres salir de publitell app?', // mensaje a mostrar
              exitFromApp, // callback a invocar cuando el botón es presionado
              'Salir', // titulo de la ventana
              'Cancelar,Si' // etiquetas de los botones
           );
     } 
    document.addEventListener("backbutton", backKeyDown, false);
    function backKeyDown(){
        if (pagina==1) {
            navigator.notification.confirm(
              '¿Seguro que quieres salir de publitell app?', // mensaje a mostrar
              exitFromApp, // callback a invocar cuando el botón es presionado
              'Salir', // titulo de la ventana
              'Cancelar,Si' // etiquetas de los botones
           );
        }else
        {
            navigator.app.backHistory()
        } 
           
    }
    function exitFromApp(buttonIndex) {
        if (buttonIndex==2){ navigator.app.exitApp();}
    }

